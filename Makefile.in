#VERSION=HEAD
VERSION=$(shell git describe)
DISTNAME=cports
DISTFILE=$(DISTNAME)-$(VERSION)

ifeq ($(shell which zsyncmake),)
ZSYNCMAKE=@echo "** zsyncmake not found, skipping creating of zsync file" >&2; true
else
ZSYNCMAKE=zsyncmake
endif

default: bootstrap

dist: do-dist

do-dist: $(DISTFILE).tar.bz2.sha1sum $(DISTFILE).tar.bz2.zsync
	@mv $(DISTFILE).tar.bz2.sha1sum releases/
	@mv $(DISTFILE).tar.bz2 releases/
	@if [ -f $(DISTFILE).tar.bz2.zsync ] ; then mv $(DISTFILE).tar.bz2.zsync releases/; fi

$(DISTFILE).tar:
	@mkdir -p releases
	@git archive --format tar --prefix $(DISTFILE)/ -o $(DISTFILE).tar $(VERSION)

$(DISTFILE).tar.bz2: $(DISTFILE).tar
	@bzip2 -f $(DISTFILE).tar

$(DISTFILE).tar.bz2.sha1sum: $(DISTFILE).tar.bz2
	@openssl sha1 $(DISTFILE).tar.bz2 > $(DISTFILE).tar.bz2.sha1sum

$(DISTFILE).tar.bz2.zsync: $(DISTFILE).tar.bz2
	@$(ZSYNCMAKE) -u $(DISTFILE).tar.bz2 $(DISTFILE).tar.bz2

clean: Documentation/clean
	#@-rm $(DISTFILE).tar

docs: Documentation/all

# update the local 'man' and 'html' branches with pregenerated output files, for
# people who don't have pandoc (and maybe to aid in google searches or something)
export-docs: Documentation/all
#	git update-ref refs/heads/man origin/man '' 2>/dev/null || true
#	GIT_INDEX_FILE=gitindex.tmp; export GIT_INDEX_FILE; \
#	rm -f $${GIT_INDEX_FILE} && \
#	git add -f Documentation/*.1 && \
#	git update-ref refs/heads/man \
#		$$(echo "Autogenerated man pages for $$(git describe)" \
#			| git commit-tree $$(git write-tree --prefix=Documentation) \
#				-p refs/heads/man) && \
	git update-ref refs/heads/html origin/html '' 2>/dev/null || true
	GIT_INDEX_FILE=gitindex.tmp; export GIT_INDEX_FILE; \
	rm -f $${GIT_INDEX_FILE} && \
	git add -f Documentation/*.html && \
	git update-ref refs/heads/html \
		$$(echo "Autogenerated html pages for $$(git describe)" \
			| git commit-tree $$(git write-tree --prefix=Documentation) \
				-p refs/heads/html)

# push the pregenerated doc files to origin/man and origin/html
push-docs: export-docs
	#git push origin man html
	git push origin html

# import pregenerated doc files from origin/man and origin/html, in case you
# don't have pandoc but still want to be able to install the docs.
import-docs: Documentation/clean
	git archive origin/html | (cd Documentation; tar -xvf -)
	#git archive origin/man | (cd Documentation; tar -xvf -)



%/all:
	$(MAKE) -C $* all

%/clean:
	$(MAKE) -C $* clean

distclean:
	@-rm -f @CONFIGURE_FILES@ @GENERATED_FILES@

whatchanged:
	(git whatchanged  `git tag -l | tail -1`..HEAD  | git shortlog)

changelog:
	(git log --pretty --summary --numstat | ./scripts/git2cl > changelog)

#docs:
#	$(MAKE) -C Documentation/all
Documentation/all:

.PHONY: whatchanged changelog

# Bootstrapping it all on machines without some basic software.

all: bootstrap

dummy:
	@echo ""

bootstrap:
	@echo ""
	@echo "To bootstrap."
	@echo ""
	@echo " > cd packages/bootstrap/1.0"
	@echo " > $(MAKE) do-cleaz"
	@echo " > $(MAKE) install"
	@echo " > cd ../2.0"
	@echo " > $(MAKE) do-cleaz"
	@echo " > $(MAKE) install"
	@echo " > $(MAKE) do-cleaz"
	@echo ""

install: all
	cd packages && $(MAKE) all

test:
	$(MAKE) -C t test

reconfig: Makefile.in
	./config.cmd
